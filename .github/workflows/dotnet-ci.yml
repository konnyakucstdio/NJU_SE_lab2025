name: .NET Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOTNET_VERSION: '4.8' # 根据你的项目实际使用的.NET版本调整

jobs:
  build-and-test:
    runs-on: windows-latest # 关键：必须在 Windows 环境运行

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 重要：删除或注释掉原来的 "Setup .NET" 步骤
    # - name: Setup .NET
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify .NET Framework (Info)
      run: |
        reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release

    - name: Restore dependencies (NuGet)
      run: nuget restore MoneyManager.sln  # 使用 nuget 为 .NET Framework 项目恢复包

    - name: Build
      run: |
        # 1. 打印当前路径和系统信息
        Write-Host "当前目录:" (Get-Location)
        Write-Host "系统 PATH 环境变量:"
        $env:PATH -split ';' | Select-String -Pattern 'MSBuild|Visual Studio' | ForEach-Object { Write-Host "  $_" }

        # 2. 测试文件是否存在（多种方法）
        $testPath = 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe'
        Write-Host "`n测试路径: $testPath"
        Write-Host "Test-Path 结果:" (Test-Path $testPath)
        Write-Host "Get-Item 结果:"; Get-Item $testPath -ErrorAction SilentlyContinue

        # 3. 尝试直接运行（不带 &）
        Write-Host "`n尝试直接运行..."
        & $testPath --version
        if ($LASTEXITCODE -eq 0) {
            Write-Host "成功！"
        } else {
            Write-Host "失败，退出码: $LASTEXITCODE"
        }

    - name: Run Unit Tests
      run: |
        # 使用 vstest.console.exe 运行测试项目
        # 路径可能需要根据你的项目结构调整
        & "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" .\MoneyManager.Tests\bin\Debug\MoneyManager.Tests.dll