name: .NET Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOTNET_VERSION: '4.8' # 根据你的项目实际使用的.NET版本调整

jobs:
  build-and-test:
    runs-on: windows-latest # 关键：必须在 Windows 环境运行

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 重要：删除或注释掉原来的 "Setup .NET" 步骤
    # - name: Setup .NET
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify .NET Framework (Info)
      run: |
        reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release

    - name: Restore dependencies (NuGet)
      run: nuget restore MoneyManager.sln  # 使用 nuget 为 .NET Framework 项目恢复包

    - name: Build
      run: |
        # 这是真正的构建步骤，使用我们之前成功的vswhere+MSBuild脚本
        $vswherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsInstallPath = & $vswherePath -latest -requires Microsoft.Component.MSBuild -property installationPath
        $msbuildPath = Join-Path $vsInstallPath "MSBuild\Current\Bin\MSBuild.exe"
        if (-not (Test-Path $msbuildPath)) {
            $msbuildPath = Join-Path $vsInstallPath "MSBuild\17.0\Bin\MSBuild.exe"
        }
        Write-Host "已找到 MSBuild: $msbuildPath"
        & $msbuildPath MoneyManager.sln /p:Configuration=Debug /verbosity:minimal

    - name: Run Unit Tests
      run: |
        Write-Host “开始运行单元测试...”
        
        # 1. 首先，找到 vstest.console.exe（测试运行器）
        # 它通常与 Visual Studio 一起安装
        $vstestPath = (Get-ChildItem -Path “C:\Program Files\Microsoft Visual Studio” -Recurse -Filter “vstest.console.exe” -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
        
        if (-not $vstestPath) {
            # 如果没找到，尝试另一个常见路径
            $vstestPath = “C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe”
        }
        
        Write-Host “找到测试运行器: $vstestPath”
        
        # 2. 指定测试DLL的路径（根据你的构建配置 Debug/Release）
        $testDllPath = “.\MoneyManager.Tests\bin\Debug\MoneyManager.Tests.dll”
        
        # 3. 运行测试
        & $vstestPath $testDllPath /Logger:trx /TestAdapterPath:“.\MoneyManager.Tests\bin\Debug”
        
        # 注意：如果测试失败，vstest.console.exe 会返回非零退出码，导致步骤失败
        # 这符合CI的预期行为