name: .NET Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOTNET_VERSION: '4.8' # 根据你的项目实际使用的.NET版本调整

jobs:
  build-and-test:
    runs-on: windows-latest # 关键：必须在 Windows 环境运行

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 重要：删除或注释掉原来的 "Setup .NET" 步骤
    # - name: Setup .NET
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify .NET Framework (Info)
      run: |
        reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release

    - name: Restore dependencies (NuGet)
      run: nuget restore MoneyManager.sln  # 使用 nuget 为 .NET Framework 项目恢复包

    - name: Build
      run: |
        cmd /c '"C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe" .\Moneymanager.tests\Moneymanager.tests.csproj /p:Configuration=Debug /t:VSTest'

    - name: Run Unit Tests
      run: |
        # 使用 vstest.console.exe 运行测试项目
        # 路径可能需要根据你的项目结构调整
        & "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" .\MoneyManager.Tests\bin\Debug\MoneyManager.Tests.dll