name: .NET Build and Test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  DOTNET_VERSION: '4.8' # 根据你的项目实际使用的.NET版本调整

jobs:
  build-and-test:
    runs-on: windows-latest # 关键：必须在 Windows 环境运行

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 重要：删除或注释掉原来的 "Setup .NET" 步骤
    # - name: Setup .NET
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Verify .NET Framework (Info)
      run: |
        reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" /v Release

    - name: Restore dependencies (NuGet)
      run: nuget restore MoneyManager.sln  # 使用 nuget 为 .NET Framework 项目恢复包

    - name: Build
      run: |
        # 1. 使用 vswhere 工具定位 MSBuild
        $vswherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        
        if (-not (Test-Path $vswherePath)) {
            Write-Error "未找到 vswhere.exe，无法定位 Visual Studio。"
            exit 1
        }
        
        # 获取最新版 Visual Studio 的安装路径
        $vsInstallPath = & $vswherePath -latest -requires Microsoft.Component.MSBuild -property installationPath
        if (-not $vsInstallPath) {
            Write-Error "未找到已安装的包含 MSBuild 的 Visual Studio。"
            exit 1
        }
        
        # 构造 MSBuild 路径 (优先使用 Current 版本)
        $msbuildPath = Join-Path $vsInstallPath "MSBuild\Current\Bin\MSBuild.exe"
        if (-not (Test-Path $msbuildPath)) {
            # 如果 Current 不存在，尝试 17.0 版本 (VS 2022)
            $msbuildPath = Join-Path $vsInstallPath "MSBuild\17.0\Bin\MSBuild.exe"
        }
        
        if (-not (Test-Path $msbuildPath)) {
            Write-Error "在 Visual Studio 安装路径中未找到 MSBuild.exe。"
            exit 1
        }
        
        Write-Host "已找到 MSBuild: $msbuildPath"
        
        # 2. 构建解决方案
        Write-Host "开始构建解决方案..."
        & $msbuildPath MoneyManager.sln /p:Configuration=Debug /verbosity:minimal
        
        # 3. 运行测试
        Write-Host "开始运行单元测试..."
        & $msbuildPath MoneyManager.sln /p:Configuration=Debug /t:VSTest

    - name: Run Unit Tests
      run: |
        # 使用 vstest.console.exe 运行测试项目
        # 路径可能需要根据你的项目结构调整
        & "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" .\MoneyManager.Tests\bin\Debug\MoneyManager.Tests.dll